generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id            String     @id @default(cuid())
  name          String
  slug          String     @unique
  clerkOrgId    String     @unique
  subscriptionStatus String @default("trial") // trial, active, canceled, past_due
  subscriptionTier String   @default("starter") // starter, professional, enterprise
  trialEndsAt   DateTime?

  // Stripe billing
  stripeCustomerId     String?  @unique
  stripeSubscriptionId String?
  stripePriceId        String?
  currentPeriodEnd     DateTime?

  // ServicePing additions
  phone         String?
  reminderEnabled Boolean @default(false)
  reminderQuietStart Int @default(21) // 9 PM
  reminderQuietEnd Int @default(9)   // 9 AM

  // AI SMS Personalization
  aiPersonalization Boolean @default(false)
  aiTone            String  @default("friendly") // friendly, professional, casual
  
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  customers     Customer[]
  followUpRecords FollowUpRecord[]
  
  // ServicePing relations
  serviceTypes  ServiceType[]
  reminderRules ReminderRule[]
  reminderTemplates ReminderTemplate[]
  reminderMessages ReminderMessage[]
  consentLogs   ConsentLog[]
  twilioConfig  TwilioConfig?
  aiConfig      AiConfig?
  appointments  Appointment[]
  locations     Location[]

  @@map("organizations")
}

model Customer {
  id          String   @id @default(cuid())
  firstName   String
  lastName    String
  phone       String
  email       String?
  status      CustomerStatus @default(up_to_date)
  tags        String[] @default([])

  // ServicePing additions
  smsConsent  Boolean @default(false)
  smsConsentDate DateTime?
  preferredContactTime String?

  orgId       String
  organization Organization @relation(fields: [orgId], references: [clerkOrgId], onDelete: Cascade)

  vehicles    Vehicle[]
  followUpRecords FollowUpRecord[]
  notes       CustomerNote[]
  appointments Appointment[]

  // ServicePing relations
  reminderMessages ReminderMessage[]
  consentLogs   ConsentLog[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([orgId])
  @@index([status])
  @@index([phone])
  @@index([firstName, lastName])
  @@map("customers")
}

model Vehicle {
  id                    String   @id @default(cuid())
  customerId            String
  customer              Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  year                  Int
  make                  String
  model                 String
  vin                   String?
  licensePlate          String?
  mileageAtLastService  Int?
  
  serviceRecords        ServiceRecord[]
  
  // ServicePing relations
  reminderMessages ReminderMessage[]
  appointments     Appointment[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([customerId])
  @@map("vehicles")
}

model ServiceRecord {
  id                String   @id @default(cuid())
  vehicleId         String
  vehicle           Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  
  serviceDate       DateTime
  mileageAtService  Int
  serviceType       String   @default("oil_change")
  notes             String?
  
  nextDueDate       DateTime
  nextDueMileage    Int
  
  followUpRecords   FollowUpRecord[]
  
  // ServicePing relations
  reminderMessages ReminderMessage[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([vehicleId])
  @@index([nextDueDate])
  @@map("service_records")
}

model FollowUpRecord {
  id                String   @id @default(cuid())
  customerId        String
  customer          Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  serviceRecordId   String
  serviceRecord     ServiceRecord @relation(fields: [serviceRecordId], references: [id], onDelete: Cascade)
  
  orgId             String
  organization      Organization @relation(fields: [orgId], references: [clerkOrgId], onDelete: Cascade)
  
  contactDate       DateTime @default(now())
  method            ContactMethod
  outcome           FollowUpOutcome
  notes             String?
  staffMember       String?
  
  createdAt         DateTime @default(now())
  
  @@index([customerId])
  @@index([orgId])
  @@index([outcome])
  @@map("follow_up_records")
}

// ==================== ServicePing New Models ====================

model ServiceType {
  id                    String   @id @default(cuid())
  orgId                 String
  organization          Organization @relation(fields: [orgId], references: [clerkOrgId], onDelete: Cascade)

  name                  String   // slug: oil_change_standard, brake_pad_inspection, etc.
  displayName           String   // "Oil Change (Standard)"
  category              String   @default("general") // oil_change, tires, brakes, etc.
  description           String?  // Brief description of the service
  sortOrder             Int      @default(0) // Display ordering within category
  defaultMileageInterval Int?    // 5000, 7500, etc.
  defaultTimeIntervalDays Int?   // 90, 180, etc.
  reminderLeadDays      Int      @default(14) // 2 weeks before

  isActive              Boolean  @default(true)
  isCustom              Boolean  @default(true) // false for system defaults

  reminderRules         ReminderRule[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([orgId])
  @@index([isActive])
  @@index([category])
  @@map("service_types")
}

model ReminderRule {
  id              String   @id @default(cuid())
  orgId           String
  organization    Organization @relation(fields: [orgId], references: [clerkOrgId], onDelete: Cascade)
  
  serviceTypeId   String
  serviceType     ServiceType @relation(fields: [serviceTypeId], references: [id], onDelete: Cascade)
  
  reminderType    String   @default("service_due") // service_due, follow_up, appointment
  sequenceNumber  Int      // 1=first reminder, 2=due date, 3=overdue
  offsetDays      Int      // -14 = 2 weeks before, 0 = on due date, 7 = 1 week after
  
  templateId      String?
  template        ReminderTemplate? @relation(fields: [templateId], references: [id])
  
  isActive        Boolean  @default(true)
  
  reminderMessages ReminderMessage[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([orgId])
  @@index([serviceTypeId])
  @@map("reminder_rules")
}

model ReminderTemplate {
  id              String   @id @default(cuid())
  orgId           String
  organization    Organization @relation(fields: [orgId], references: [clerkOrgId], onDelete: Cascade)
  
  name            String   // "First Reminder", "Due Date", "Overdue"
  body            String   // Template with {{variables}}
  isDefault       Boolean  @default(false)
  
  reminderRules   ReminderRule[]
  reminderMessages ReminderMessage[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([orgId])
  @@map("reminder_templates")
}

model ReminderMessage {
  id              String   @id @default(cuid())
  orgId           String
  organization    Organization @relation(fields: [orgId], references: [clerkOrgId], onDelete: Cascade)
  
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  vehicleId       String?
  vehicle         Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  
  serviceRecordId String?
  serviceRecord   ServiceRecord? @relation(fields: [serviceRecordId], references: [id], onDelete: SetNull)
  
  reminderRuleId  String?
  reminderRule    ReminderRule? @relation(fields: [reminderRuleId], references: [id], onDelete: SetNull)
  
  templateId      String?
  template        ReminderTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  
  scheduledAt     DateTime
  sentAt          DateTime?
  
  twilioSid       String?
  status          MessageStatus @default(queued)
  statusUpdatedAt DateTime?
  
  direction       MessageDirection @default(outbound)
  body            String
  aiGenerated     Boolean  @default(false)
  
  // For inbound messages
  fromPhone       String?
  toPhone         String?
  
  createdAt       DateTime @default(now())
  
  @@index([orgId])
  @@index([customerId])
  @@index([status])
  @@index([scheduledAt])
  @@map("reminder_messages")
}

model ConsentLog {
  id              String   @id @default(cuid())
  orgId           String
  organization    Organization @relation(fields: [orgId], references: [clerkOrgId], onDelete: Cascade)
  
  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  action          ConsentAction
  source          ConsentSource
  performedBy     String?  // staffId or "system"
  notes           String?
  
  createdAt       DateTime @default(now())
  
  @@index([orgId])
  @@index([customerId])
  @@index([createdAt])
  @@map("consent_logs")
}

model TwilioConfig {
  id              String   @id @default(cuid())
  orgId           String   @unique
  organization    Organization @relation(fields: [orgId], references: [clerkOrgId], onDelete: Cascade)
  
  accountSid      String   // Encrypted
  authToken       String   // Encrypted
  phoneNumber     String
  
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([orgId])
  @@map("twilio_configs")
}

model AiConfig {
  id              String   @id @default(cuid())
  orgId           String   @unique
  organization    Organization @relation(fields: [orgId], references: [clerkOrgId], onDelete: Cascade)

  provider        String   @default("anthropic") // anthropic, openai, google
  model           String   @default("claude-haiku-4-5-20251001")
  apiKey          String   // Encrypted

  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orgId])
  @@map("ai_configs")
}

model Location {
  id              String   @id @default(cuid())
  orgId           String
  organization    Organization @relation(fields: [orgId], references: [clerkOrgId], onDelete: Cascade)

  name            String
  address         String?
  phone           String?
  isDefault       Boolean  @default(false)
  isActive        Boolean  @default(true)

  appointments    Appointment[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orgId])
  @@map("locations")
}

model Appointment {
  id              String   @id @default(cuid())
  orgId           String
  organization    Organization @relation(fields: [orgId], references: [clerkOrgId], onDelete: Cascade)

  customerId      String
  customer        Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  vehicleId       String?
  vehicle         Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  scheduledAt     DateTime
  duration        Int      @default(60) // minutes
  status          AppointmentStatus @default(scheduled)

  locationId      String?
  location        Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  serviceTypeNames String[] @default([])
  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([orgId])
  @@index([customerId])
  @@index([scheduledAt])
  @@index([status])
  @@map("appointments")
}

model CustomerNote {
  id          String   @id @default(cuid())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  body        String
  createdBy   String   // userId from Clerk

  createdAt   DateTime @default(now())

  @@index([customerId])
  @@map("customer_notes")
}

// ==================== Enums ====================

enum CustomerStatus {
  overdue
  due_now
  due_soon
  up_to_date
}

enum ContactMethod {
  call
  text
  email
}

enum FollowUpOutcome {
  scheduled
  not_interested
  no_response
  serviced_elsewhere
  left_message
  wrong_number
}

enum MessageStatus {
  queued
  sent
  delivered
  failed
  undelivered
}

enum MessageDirection {
  outbound
  inbound
}

enum AppointmentStatus {
  scheduled
  confirmed
  in_progress
  completed
  cancelled
  no_show
}

enum ConsentAction {
  opt_in
  opt_out
}

enum ConsentSource {
  sms_reply
  manual
  csv_import
  signup
}
